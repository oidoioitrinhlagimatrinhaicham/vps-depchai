<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Celestia Capsules</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      color-scheme: dark;
      --page: #030711;
      --glow-one: #b7e7ff;
      --glow-two: #fdc5ff;
      --panel: rgba(8, 12, 24, 0.86);
      --border: rgba(255, 255, 255, 0.08);
      --muted: #9ab0c7;
      --accent: #82d3ff;
      --accent-strong: #ffb0f4;
      --success: #72f5c5;
      --error: #ffb3b3;
      --warning: #ffd18c;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Manrope', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(183, 231, 255, 0.25), transparent 45%),
        radial-gradient(circle at 80% 10%, rgba(253, 197, 255, 0.35), transparent 45%),
        var(--page);
      color: #f6f7fb;
      padding: 36px 18px 60px;
    }

    .veil::before,
    .veil::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(rgba(255, 255, 255, 0.14) 1px, transparent 1px);
      background-size: 150px 150px;
      opacity: 0.1;
      pointer-events: none;
      z-index: -2;
    }

    .veil::after {
      background-size: 100px 100px;
      opacity: 0.07;
      animation: drift 55s linear infinite;
    }

    @keyframes drift {
      to {
        transform: translate3d(-130px, -90px, 0);
      }
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
    }

    .hero {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 28px;
      background: linear-gradient(120deg, rgba(130, 211, 255, 0.2), rgba(255, 176, 244, 0.18));
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 34px;
      padding: 32px;
      margin-bottom: 34px;
      box-shadow: 0 30px 70px rgba(3, 5, 12, 0.65);
    }

    .hero__copy h1 {
      font-size: clamp(2.2rem, 4vw, 3.2rem);
      margin: 8px 0 16px;
      letter-spacing: -0.5px;
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.3em;
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.75);
    }

    .hero__copy p {
      color: var(--muted);
      line-height: 1.6;
      max-width: 520px;
    }

    .hero__facts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 14px;
    }

    .fact-card {
      background: rgba(2, 7, 18, 0.6);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
    }

    .fact-card span {
      display: block;
      font-size: 0.82rem;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .fact-card strong {
      font-size: 1.5rem;
    }

    .panels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 22px;
      margin-bottom: 32px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    .panel h2 {
      font-size: 1.35rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel p {
      color: var(--muted);
      margin-bottom: 22px;
      line-height: 1.5;
    }

    .field-label {
      font-size: 0.95rem;
      margin-bottom: 8px;
      color: var(--muted);
    }

    .input-shell {
      position: relative;
    }

    .input-shell i {
      position: absolute;
      top: 50%;
      left: 16px;
      transform: translateY(-50%);
      color: var(--accent);
    }

    input[type="password"] {
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 6, 20, 0.8);
      color: #f9fbff;
      padding: 16px 18px 16px 50px;
      font-size: 1rem;
      font-family: inherit;
    }

    input[type="password"]:focus {
      outline: none;
      border-color: rgba(130, 211, 255, 0.8);
      box-shadow: 0 0 0 3px rgba(130, 211, 255, 0.2);
    }

    .cta {
      margin-top: 18px;
      width: 100%;
      border: none;
      border-radius: 18px;
      padding: 16px;
      font-size: 1.05rem;
      font-weight: 600;
      background: linear-gradient(135deg, #82d3ff, #ffb0f4);
      color: #041123;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .cta:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .cta:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(255, 176, 244, 0.4);
    }

    .status-banner {
      margin-top: 16px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      padding: 14px 16px;
      font-size: 0.95rem;
      display: none;
    }

    .status-banner.show {
      display: block;
    }

    .status-banner.success {
      border-color: rgba(114, 245, 197, 0.6);
      color: var(--success);
    }

    .status-banner.error {
      border-color: rgba(255, 179, 179, 0.5);
      color: var(--error);
    }

    .list-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }

    .list-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .ghost-btn {
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.04);
      color: #fff;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .ghost-btn:hover {
      border-color: rgba(255, 255, 255, 0.35);
    }

    .capsule-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .capsule-card {
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 22px;
      padding: 16px 18px;
      background: rgba(1, 5, 18, 0.65);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .capsule-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .capsule-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .capsule-meta strong {
      font-size: 1rem;
    }

    .status-pill {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      text-transform: capitalize;
    }

    .status-ready {
      background: rgba(114, 245, 197, 0.15);
      color: var(--success);
    }

    .status-creating,
    .status-provisioning {
      background: rgba(130, 211, 255, 0.15);
      color: var(--accent);
    }

    .status-error {
      background: rgba(255, 179, 179, 0.15);
      color: var(--error);
    }

    .capsule-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .log-board {
      margin-top: 18px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding-top: 14px;
    }

    .log-head {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-feed {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 160px;
      overflow-y: auto;
    }

    .log-feed li {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 12px;
      font-size: 0.85rem;
      color: var(--muted);
      align-items: baseline;
    }

    .log-feed time {
      font-variant-numeric: tabular-nums;
      color: rgba(255, 255, 255, 0.7);
    }

    .log-empty {
      font-style: italic;
      opacity: 0.75;
      grid-template-columns: 1fr !important;
    }

    .mini-btn {
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 14px;
      padding: 8px 12px;
      background: transparent;
      color: #fff;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .mini-btn:hover {
      border-color: rgba(255, 255, 255, 0.35);
    }

    .mini-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .capsule-link {
      color: var(--muted);
      font-size: 0.9rem;
      word-break: break-all;
    }

    .guide {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-top: 40px;
    }

    .guide-card {
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px;
      padding: 20px;
      background: rgba(1, 6, 16, 0.65);
    }

    .guide-card span {
      display: inline-flex;
      width: 36px;
      height: 36px;
      border-radius: 12px;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.08);
      margin-bottom: 10px;
      font-weight: 600;
    }

    .guide-card p {
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.5;
    }

    .auto-start-callout {
      display: flex;
      align-items: center;
      gap: 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 26px;
      padding: 20px 28px;
      background: rgba(9, 13, 24, 0.8);
      margin-bottom: 32px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
    }

    .auto-icon {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      display: grid;
      place-items: center;
      background: rgba(255, 176, 244, 0.18);
      font-size: 1.4rem;
      color: var(--accent-strong);
    }

    .auto-start-callout p {
      color: var(--muted);
      margin: 4px 0 0;
      line-height: 1.5;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9rem;
    }

    .empty-state {
      text-align: center;
      padding: 30px 10px;
      border: 1px dashed rgba(255, 255, 255, 0.2);
      border-radius: 18px;
      color: var(--muted);
    }

    @media (max-width: 768px) {
      body {
        padding: 26px 14px 40px;
      }

      .hero {
        padding: 24px;
      }

      .panel {
        padding: 22px;
      }
    }
  </style>
</head>
<body class="veil">
  <div class="wrap">
    <header class="hero">
      <div class="hero__copy">
        <p class="eyebrow">Celestia Capsules</p>
        <h1>Khởi tạo capsule đồ họa và nhận link truy cập trong vài phút.</h1>
        <p>
          Mỗi capsule là một môi trường đồ họa tạm thời với giao diện web tích hợp. Chỉ cần cấp khóa truy cập,
          hệ thống sẽ lo phần còn lại và gửi link điều khiển trực tiếp khi hoàn tất.
        </p>
      </div>
      <div class="hero__facts">
        <div class="fact-card">
          <span>Chu kỳ</span>
          <strong>≈ 5.5h</strong>
        </div>
        <div class="fact-card">
          <span>Bảo toàn</span>
          <strong>1 phiên</strong>
        </div>
        <div class="fact-card">
          <span>Tên dự án</span>
          <strong>Celestia</strong>
        </div>
        <div class="fact-card">
          <span>Auto start</span>
          <strong>Luôn bật</strong>
        </div>
      </div>
    </header>

    <section class="auto-start-callout">
      <div class="auto-icon"><i class="fas fa-arrows-rotate"></i></div>
      <div>
        <h3>Auto start pulse</h3>
        <p>Các capsule mới được đính kèm workflow auto start để tự kích hoạt lại khi có thay đổi hoặc khi bạn đẩy cập nhật.
          Bạn chỉ cần tạo một lần, phần khởi động lại Celestia sẽ tự lo.</p>
      </div>
    </section>

    <section class="panels">
      <div class="panel">
        <h2><i class="fas fa-sun"></i> Capsule mới</h2>
        <p>Nhập khóa để kích hoạt workflow Celestia. Kết quả sẽ tự động xuất hiện trong bảng hoạt động.</p>
        <form id="createForm">
          <label for="accessKey" class="field-label">Khóa Celestia</label>
          <div class="input-shell">
            <i class="fas fa-key"></i>
            <input type="password" id="accessKey" placeholder="sk_live_xxxxxxxxx" autocomplete="off" />
          </div>
          <button type="submit" class="cta" id="createBtn">
            <span id="createBtnLabel">Kích hoạt capsule</span>
          </button>
          <div class="status-banner" id="statusBanner"></div>
        </form>
      </div>

      <div class="panel">
        <div class="list-head">
          <div>
            <h2><i class="fas fa-wave-square"></i> Nhật ký capsule</h2>
            <p>Các capsule sẽ cập nhật trạng thái và đường dẫn truy cập ngay tại đây.</p>
          </div>
          <div class="list-actions">
            <button type="button" class="ghost-btn" id="refreshList"><i class="fas fa-rotate"></i> Làm mới</button>
            <button type="button" class="ghost-btn" id="clearHistory"><i class="fas fa-trash"></i> Xóa toàn bộ</button>
          </div>
        </div>
        <div id="capsuleList" class="capsule-list"></div>
      </div>
    </section>

    <section class="panel">
      <h2><i class="fas fa-compass"></i> Hướng dẫn 3 bước</h2>
      <div class="guide">
        <div class="guide-card">
          <span>1</span>
          <h3>Nhập khóa</h3>
          <p>Dán khóa truy cập vào ô Capsule mới rồi kích hoạt.</p>
        </div>
        <div class="guide-card">
          <span>2</span>
          <h3>Đợi workflow</h3>
          <p>Trong 5-10 phút, workflow sẽ cấu hình capsule và gửi callback.</p>
        </div>
        <div class="guide-card">
          <span>3</span>
          <h3>Mở đường dẫn</h3>
          <p>Ngay khi trạng thái chuyển sang "Ready", sao chép hoặc mở link từ nhật ký.</p>
        </div>
      </div>
    </section>

    <footer>Celestia Capsules · Crafted for lightweight control panels.</footer>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const capsuleList = document.getElementById('capsuleList');
    const createForm = document.getElementById('createForm');
    const createBtn = document.getElementById('createBtn');
    const createBtnLabel = document.getElementById('createBtnLabel');
    const statusBanner = document.getElementById('statusBanner');

    const statusStyles = {
      ready: 'status-ready',
      provisioning: 'status-creating',
      creating: 'status-creating',
      error: 'status-error',
    };

    function setBanner(message, type) {
      if (!message) {
        statusBanner.className = 'status-banner';
        statusBanner.textContent = '';
        return;
      }
      statusBanner.textContent = message;
      statusBanner.className = `status-banner show ${type}`;
    }

    function setLoading(isLoading) {
      if (isLoading) {
        createBtn.disabled = true;
        createBtnLabel.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi';
      } else {
        createBtn.disabled = false;
        createBtnLabel.textContent = 'Kích hoạt capsule';
      }
    }

    async function parseApiResponse(response) {
      const text = await response.text();
      if (!text) return {};
      try {
        return JSON.parse(text);
      } catch (error) {
        return { __raw: text };
      }
    }

    function extractError(data, fallbackMessage) {
      if (!data) return fallbackMessage;
      return data.error || data.details || data.message || data.__raw || fallbackMessage;
    }

    async function createCapsule() {
      const token = document.getElementById('accessKey').value.trim();
      if (!token) {
        setBanner('Vui lòng nhập khóa trước khi kích hoạt.', 'error');
        return;
      }
      setLoading(true);
      setBanner('', '');
      try {
        const response = await fetch(`${API_BASE}/api/create-vps`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ github_token: token })
        });
        const data = await parseApiResponse(response);
        if (response.ok) {
          setBanner(data.message || 'Workflow đã được kích hoạt.', 'success');
          document.getElementById('accessKey').value = '';
          setTimeout(loadCapsules, 2000);
        } else {
          throw new Error(extractError(data, 'Không thể kích hoạt capsule.'));
        }
      } catch (error) {
        setBanner(error.message, 'error');
      } finally {
        setLoading(false);
      }
    }

    function formatRelativeTime(iso) {
      if (!iso) return 'Chưa rõ thời gian';
      const now = new Date();
      const past = new Date(iso);
      const diff = Math.max(0, now - past);
      const minutes = Math.floor(diff / 60000);
      if (minutes < 1) return 'Vừa xong';
      if (minutes < 60) return `${minutes} phút trước`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} giờ trước`;
      const days = Math.floor(hours / 24);
      return `${days} ngày trước`;
    }

    function escapeHTML(str = '') {
      return str.replace(/[&<>"']/g, (char) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[char] || char));
    }

    function formatLogTime(iso) {
      if (!iso) return '--:--:--';
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) return '--:--:--';
      return date.toLocaleTimeString('vi-VN', { hour12: false });
    }

    function buildCapsuleCard(entry) {
      const { repo, remote_link: link, status = 'creating', token_hint: tokenHint, updated_at: updatedAt, requested_at: requestedAt, logs = [] } = entry;
      const pillClass = statusStyles[status] || 'status-creating';
      const statusLabel = status === 'ready' ? 'Ready' : status === 'error' ? 'Error' : 'Pending';
      const infoLines = [
        tokenHint ? `Key: ${tokenHint}` : null,
        requestedAt ? `Bắt đầu: ${new Date(requestedAt).toLocaleString('vi-VN')}` : null,
        updatedAt ? `Cập nhật: ${formatRelativeTime(updatedAt)}` : null,
      ].filter(Boolean).join(' • ');
      const latestLogs = Array.isArray(logs) ? logs.slice(-6).reverse() : [];
      const logsMarkup = latestLogs.length
        ? latestLogs.map((log) => `<li><time>${formatLogTime(log.at)}</time><span>${escapeHTML(log.message || '')}</span></li>`).join('')
        : '<li class="log-empty"><span>Chưa có tín hiệu workflow.</span></li>';

      const wrapper = document.createElement('div');
      wrapper.className = 'capsule-card';
      wrapper.innerHTML = `
        <div class="capsule-top">
          <div class="capsule-meta">
            <strong>${repo}</strong>
            <small class="capsule-link">${infoLines || 'Đang đợi phản hồi...'}</small>
          </div>
          <span class="status-pill ${pillClass}">${statusLabel}</span>
        </div>
        <div class="capsule-link">${link ? link : 'Link sẽ xuất hiện tự động khi capsule sẵn sàng.'}</div>
        <div class="capsule-actions">
          <button class="mini-btn" ${link ? '' : 'disabled'} data-action="copy"><i class="fas fa-copy"></i> Copy link</button>
          <button class="mini-btn" ${link ? '' : 'disabled'} data-action="open"><i class="fas fa-arrow-up-right-from-square"></i> Mở</button>
          <button class="mini-btn" data-action="delete"><i class="fas fa-xmark"></i> Xóa</button>
        </div>
        <div class="log-board">
          <div class="log-head"><i class="fas fa-terminal"></i> Log gần nhất</div>
          <ul class="log-feed">${logsMarkup}</ul>
        </div>
      `;

      wrapper.querySelector('[data-action="copy"]').addEventListener('click', () => {
        if (!link) return;
        navigator.clipboard.writeText(link).then(() => {
          setBanner('Đã sao chép link capsule.', 'success');
        }).catch(() => setBanner('Không thể sao chép link.', 'error'));
      });

      wrapper.querySelector('[data-action="open"]').addEventListener('click', () => {
        if (!link) return;
        window.open(link, '_blank');
      });

      wrapper.querySelector('[data-action="delete"]').addEventListener('click', () => deleteCapsule(repo));
      return wrapper;
    }

    function renderCapsules(users) {
      capsuleList.innerHTML = '';
      if (!users || users.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.innerHTML = '<i class="fas fa-moon"></i><p>Chưa có capsule nào. Kích hoạt một phiên mới để bắt đầu.</p>';
        capsuleList.appendChild(empty);
        return;
      }

      users.forEach((entry) => {
        capsuleList.appendChild(buildCapsuleCard(entry));
      });
    }

    async function loadCapsules() {
      capsuleList.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Đang tải nhật ký...</p></div>';
      try {
        const response = await fetch(`${API_BASE}/api/vpsuser`);
        const data = await parseApiResponse(response);
        if (response.ok && data.status === 'success') {
          renderCapsules(data.users || []);
        } else {
          throw new Error(extractError(data, 'Không thể tải nhật ký.'));
        }
      } catch (error) {
        capsuleList.innerHTML = `<div class="empty-state" style="color: var(--error)">${error.message}</div>`;
      }
    }

    async function deleteCapsule(repo) {
      if (!repo) return;
      try {
        const response = await fetch(`${API_BASE}/api/vpsuser`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ repo })
        });
        const data = await parseApiResponse(response);
        if (response.ok) {
          setBanner('Đã xóa một capsule khỏi nhật ký.', 'success');
          loadCapsules();
        } else {
          throw new Error(extractError(data, 'Không thể xóa.'));
        }
      } catch (error) {
        setBanner(error.message, 'error');
      }
    }

    async function clearHistory() {
      try {
        const response = await fetch(`${API_BASE}/api/vpsuser`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        const data = await parseApiResponse(response);
        if (response.ok) {
          setBanner('Nhật ký đã được làm trống.', 'success');
          loadCapsules();
        } else {
          throw new Error(extractError(data, 'Không thể xóa lịch sử.'));
        }
      } catch (error) {
        setBanner(error.message, 'error');
      }
    }

    createForm.addEventListener('submit', (event) => {
      event.preventDefault();
      createCapsule();
    });

    document.getElementById('refreshList').addEventListener('click', loadCapsules);
    document.getElementById('clearHistory').addEventListener('click', clearHistory);
    window.addEventListener('load', loadCapsules);
  </script>
</body>
</html>
